name: ğŸ“º IPTV åˆ—è¡¨

on:
  workflow_dispatch:    # ğŸ® æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: "0 */12 * * *"  # â° æ¯12å°æ—¶è¿è¡Œä¸€æ¬¡ (UTCæ—¶é—´)

jobs:
  iptv-updater:
    name: ğŸ“ºæ„å»º IPTV åˆ—è¡¨
    runs-on: ubuntu-latest
    
    steps:
      # =====================
      # ğŸ› ï¸ ç¯å¢ƒåˆå§‹åŒ–
      # =====================
      - name: "ğŸ”§ åˆå§‹åŒ–ç¯å¢ƒ"
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          echo "ğŸ“¦ æ›´æ–°è½¯ä»¶æº..."
          sudo -E apt-get -qq update
          
          echo "ğŸ”§ å®‰è£…å¿…è¦å·¥å…·..."
          sudo -E apt-get -qq install curl sed
          
          echo "ğŸ§¹ æ¸…ç†ç³»ç»Ÿç©ºé—´..."
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          
          echo "ğŸŒ è®¾ç½®ä¸Šæµ·æ—¶åŒº..."
          sudo timedatectl set-timezone "Asia/Shanghai"
          
          echo "ğŸ“‚ åˆ›å»ºå·¥ä½œç›®å½•..."
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir
          echo "âœ… ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

      # =====================
      # ğŸ“¥ æ•°æ®è·å–
      # =====================
      - name: "ğŸ“¥ ä¸‹è½½åŸå§‹åˆ—è¡¨"
        run: |
          cd /workdir
          echo "â¬ æ­£åœ¨ä¸‹è½½åŸå§‹IPTVåˆ—è¡¨..."
          curl -s -o iptv-original.m3u https://raw.githubusercontent.com/Mursor/LIVE/refs/heads/main/iptv.m3u
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸‹è½½æˆåŠŸ
          if [ ! -s iptv-original.m3u ]; then
            echo "âŒ æ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼"
            exit 1
          fi
          echo "âœ… ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶å¤§å°: $(du -h iptv-original.m3u | cut -f1)"

      # =====================
      # âœ‚ï¸ æ–‡ä»¶å¤„ç†
      # =====================
      - name: "âœ‚ï¸ å¤„ç†M3Uæ–‡ä»¶"
        run: |
          cd /workdir
          echo "ğŸ”ª åˆ é™¤ç¬¬2-5è¡Œå†…å®¹..."
          sed -i.bak -e '2,5d' iptv-original.m3u
          
          echo "ğŸ”„ é‡å‘½åæ–‡ä»¶..."
          mv iptv-original.m3u iptv.m3u
          
          echo "ğŸ“ å¤„ç†åçš„è¡Œæ•°: $(wc -l < iptv.m3u)"
          echo "âœ… æ–‡ä»¶å¤„ç†å®Œæˆ"

      # =====================
      # ğŸš€ ç»“æœå‘å¸ƒ
      # =====================
      - name: "ğŸ“‚ æ£€å‡ºç›®æ ‡ä»“åº“"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "ğŸ“¤ å¤åˆ¶å¤„ç†åçš„æ–‡ä»¶"
        run: |
          echo "ğŸ“‹ å¤åˆ¶æ–‡ä»¶åˆ°ä»“åº“æ ¹ç›®å½•..."
          cp -f /workdir/iptv.m3u ./
          echo "âœ… æ–‡ä»¶å¤åˆ¶å®Œæˆ"

      - name: "ğŸš€ æäº¤æ›´æ–°"
        run: |
          # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·æ—¶é—´
          export TZ='Asia/Shanghai'
          
          # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@users.noreply.github.com"
          
          # æ·»åŠ æ–‡ä»¶
          git add iptv.m3u
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŒ–
          if git diff --cached --quiet; then
            echo "ğŸ”„ æ–‡ä»¶å†…å®¹æœªå˜åŒ–ï¼Œæ— éœ€æäº¤"
          else
            # è·å–å½“å‰åŒ—äº¬æ—¶é—´
            CURRENT_TIME=$(date +'%Y-%m-%d %H:%M')
            
            # æäº¤æ›´æ”¹
            git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°IPTVåˆ—è¡¨ [$CURRENT_TIME]"
            
            # æ¨é€åˆ°ä»“åº“
            git push origin HEAD:${{ github.ref_name }}
            echo "ğŸš€ IPTVåˆ—è¡¨å·²æ›´æ–°å¹¶ä¿å­˜åˆ°ä»“åº“æ ¹ç›®å½•ï¼"
          fi

      # =====================
      # ğŸ§¹ æ¸…ç†ç»´æŠ¤
      # =====================
      - name: "ğŸ§¹ æ¸…ç†å·¥ä½œæµå†å²"
        uses: GitRML/delete-workflow-runs@main
        with:
          retain_days: 1
          keep_minimum_runs: 3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
