name: ğŸš€ SmartDNS

on:
  workflow_dispatch:    # ğŸ® æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: "0 16 * * *"  # â° æ¯å¤©åŒ—äº¬æ—¶é—´ 0:00 è‡ªåŠ¨è¿è¡Œ (UTCæ—¶é—´16:00)

env:
  REPO_URL: https://github.com/felixonmars/dnsmasq-china-list
  REPO_BRANCH: master

jobs:
  config-builder:
    name: ğŸ”§æ„å»º SmartDNS è§„åˆ™
    runs-on: ubuntu-22.04
    
    steps:
      # =====================
      # ğŸ› ï¸ ç¯å¢ƒåˆå§‹åŒ–
      # =====================
      - name: "ğŸ”§ åˆå§‹åŒ–ç¯å¢ƒ"
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          echo "ğŸ—‘ï¸ æ¸…ç†ç³»ç»Ÿç¼“å­˜..."
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          
          echo "ğŸ“¦ æ›´æ–°è½¯ä»¶æº..."
          sudo -E apt-get -qq update
          
          echo "ğŸ”§ å®‰è£…ç¼–è¯‘å·¥å…·..."
          sudo -E apt-get -qq install make
          
          echo "ğŸ§¹ æ¸…ç†ç³»ç»Ÿç©ºé—´..."
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          
          echo "ğŸŒ è®¾ç½®ä¸Šæµ·æ—¶åŒº..."
          sudo timedatectl set-timezone "Asia/Shanghai"
          
          echo "ğŸ“‚ åˆ›å»ºå·¥ä½œç›®å½•..."
          sudo mkdir -p /DNS
          sudo chown $USER:$GROUPS /DNS
          echo "âœ… ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

      # =====================
      # ğŸ“¥ æ•°æ®è·å–
      # =====================
      - name: "ğŸ“¥ å…‹éš†è§„åˆ™ä»“åº“"
        run: |
          cd /DNS
          echo "â¬ æ­£åœ¨å…‹éš† $REPO_URL..."
          git clone $REPO_URL -b $REPO_BRANCH dnsmasq-china-list --depth 1
          echo "âœ… ä»“åº“å…‹éš†å®Œæˆ"

      # =====================
      # ğŸ”¨ è§„åˆ™ç¼–è¯‘
      # =====================
      - name: "ğŸ”¨ ç¼–è¯‘å›½å†…åŸŸåè§„åˆ™"
        run: |
          cd /DNS/dnsmasq-china-list
          echo "ğŸ› ï¸ ç”Ÿæˆå›½å†…åŸŸåè§„åˆ™..."
          make SERVER=cn SMARTDNS_SPEEDTEST_MODE=tcp:80 smartdns-domain-rules
          echo "âœ… è§„åˆ™ç”Ÿæˆå®Œæˆ"

      - name: "ğŸ‡¨ğŸ‡³ ç”Ÿæˆä¸­å›½åˆ—è¡¨è§„åˆ™"
        run: |
          cd /DNS/dnsmasq-china-list
          echo "â¬ ä¸‹è½½ä¸­å›½åŸŸååˆ—è¡¨..."
          wget -q https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/china-list.txt -O chinalist.txt
          
          echo "ğŸ”„ è½¬æ¢ä¸ºSmartDNSæ ¼å¼..."
          sed -e "s|\(.*\)|domain-rules /\1/ -speed-check-mode tcp:80 -address - -nameserver cn|" chinalist.txt > chinalist.domain.smartdns.conf
          echo "âœ… ä¸­å›½åˆ—è¡¨è§„åˆ™ç”Ÿæˆå®Œæˆ"

      - name: "ğŸŒ ç”ŸæˆGFWåˆ—è¡¨è§„åˆ™"
        run: |
          cd /DNS/dnsmasq-china-list
          echo "â¬ ä¸‹è½½GFWåŸŸååˆ—è¡¨..."
          wget -q https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/gfw.txt -O gfwlist.txt
          
          echo "ğŸ”„ è½¬æ¢ä¸ºSmartDNSæ ¼å¼..."
          sed -e "s|\(.*\)|domain-rules /\1/ -speed-check-mode none -nameserver gfw|" gfwlist.txt > gfwlist.domain.smartdns.conf
          echo "âœ… GFWåˆ—è¡¨è§„åˆ™ç”Ÿæˆå®Œæˆ"

      # =====================
      # ğŸš€ ç»“æœå‘å¸ƒ
      # =====================
      - name: "ğŸ“‚ æ£€å‡ºç›®æ ‡ä»“åº“"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "ğŸ“¤ å¤åˆ¶é…ç½®æ–‡ä»¶"
        run: |
          echo "ğŸ“‹ å¤åˆ¶ç”Ÿæˆçš„é…ç½®æ–‡ä»¶..."
          cp -rf /DNS/dnsmasq-china-list/*.domain.smartdns.conf ./
          echo "âœ… é…ç½®æ–‡ä»¶å¤åˆ¶å®Œæˆ"

      - name: "ğŸš€ æäº¤æ›´æ–°"
        run: |
          # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·æ—¶é—´
          export TZ='Asia/Shanghai'
          
          # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@users.noreply.github.com"
          
          # æ·»åŠ æ‰€æœ‰å˜åŒ–æ–‡ä»¶
          git add .
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŒ–
          if git diff --cached --quiet; then
            echo "ğŸ”„ æ–‡ä»¶å†…å®¹æœªå˜åŒ–ï¼Œæ— éœ€æäº¤"
          else
            # è·å–å½“å‰åŒ—äº¬æ—¶é—´
            CURRENT_TIME=$(date +'%Y-%m-%d %H:%M')
            
            # æäº¤æ›´æ”¹
            git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°SmartDNSé…ç½® [$CURRENT_TIME]"
            
            # æ¨é€åˆ°ä»“åº“
            git push origin HEAD:${{ github.ref_name }}
            echo "ğŸš€ SmartDNSé…ç½®å·²æ›´æ–°å¹¶æ¨é€åˆ°ä»“åº“ï¼"
          fi

      # =====================
      # ğŸ§¹ æ¸…ç†ç»´æŠ¤
      # =====================
      - name: "ğŸ§¹ æ¸…ç†å·¥ä½œæµå†å²"
        uses: GitRML/delete-workflow-runs@main
        with:
          retain_days: 1
          keep_minimum_runs: 3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
